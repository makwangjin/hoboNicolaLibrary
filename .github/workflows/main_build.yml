name: Forced Arduino Build (CH9329 Translator)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  PICO_BOARD: rpipico
  SKETCH_PATH: examples/rp_hobo_nicola/rp_hobo_nicola.ino

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Configure Arduino Core (Pico)
        run: |
          arduino-cli core update-index --additional-urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json
          arduino-cli core install rp2040:rp2040 --additional-urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json
          arduino-cli lib install "Adafruit TinyUSB Library"

      - name: Build and Compile INO file
        run: |
          # 라이브러리 심볼릭 링크 설정 (중요)
          mkdir -p $HOME/Arduino/libraries
          ln -s $GITHUB_WORKSPACE $HOME/Arduino/libraries/hoboNicolaLibrary
          
          # 컴파일 실행
          arduino-cli compile --fqbn rp2040:rp2040:${{ env.PICO_BOARD }}:usbstack=tinyusb ${{ env.SKETCH_PATH }}
          
          # 빌드된 .uf2 파일 위치를 찾습니다.
          BUILD_DIR=$(find $HOME/.arduino15 -name "${{ env.PICO_BOARD }}" -type d | grep build)
          
          # [수정] 이 경로는 Arduino CLI 버전에 따라 다르므로, /tmp 폴더에서 찾습니다.
          cp -f $BUILD_DIR/${{ env.SKETCH_PATH }}.bin.uf2 ./rp_hobo_nicola_translator.uf2 || true

      - name: Find and Upload UF2 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ch9329-translator-firmware
          path: $HOME/.arduino15/build/*/build.build/rp_hobo_nicola.ino.uf2
          # path: ./rp_hobo_nicola_translator.uf2 # (fallback)
